<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Insitra</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* ESTILOS CORE */
        :root {
            --primary-dark: #0f1c55;
            --primary-blue: #1a2980;
            --accent-color: #AB096A;
            --bg-light: #f4f7fc;
            --white: #ffffff;
            --text-grey: #555;
            
            /* COLORES ESTADOS ACTUALIZADOS */
            --st-abierto: #e74c3c;    /* Rojo */
            --st-espera: #f39c12;     /* Naranja */
            --st-atencion: #f1c40f;   /* Amarillo */
            --st-resuelto: #27ae60;   /* Verde */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg-light); min-height: 100vh; display: flex; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--primary-blue) 0%, var(--primary-dark) 100%); color: white; position: fixed; height: 100%; z-index: 100; box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 30px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu-item { padding: 16px 25px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 12px; color: rgba(255,255,255,0.75); text-decoration: none; font-size: 0.95rem; border-left: 4px solid transparent; }
        .menu-item:hover, .menu-item.active { background-color: rgba(255,255,255,0.1); color: white; border-left-color: var(--accent-color); }

        /* MAIN CONTENT */
        .main-content { margin-left: 260px; width: calc(100% - 260px); padding: 40px; }
        h1.section-title { color: var(--primary-dark); margin-bottom: 30px; font-weight: 700; position: relative; padding-bottom: 15px; border-bottom: 4px solid var(--accent-color); display: inline-block; }

        /* KPI & CARDS */
        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .kpi-card { background: var(--white); padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); position: relative; overflow: hidden; display: flex; justify-content: space-between; align-items: center; }
        .kpi-content h3 { font-size: 0.9rem; color: var(--text-grey); margin-bottom: 10px; text-transform: uppercase; }
        .kpi-content .number { font-size: 2.5rem; font-weight: 800; line-height: 1; }
        .kpi-icon { font-size: 3.5rem; opacity: 0.15; position: absolute; right: 20px; bottom: 15px; }
        
        .card-total { border-bottom: 4px solid var(--primary-blue); } .card-total .number { color: var(--primary-blue); }
        .card-abierto { background: linear-gradient(135deg, #fff 60%, #ffebee 100%); border-bottom: 4px solid var(--st-abierto); } .card-abierto .number { color: var(--st-abierto); }
        .card-atencion { background: linear-gradient(135deg, #fff 60%, #fff9c4 100%); border-bottom: 4px solid var(--st-atencion); } .card-atencion .number { color: #d4ac0d; }
        .card-resuelto { background: linear-gradient(135deg, #fff 60%, #e8f5e9 100%); border-bottom: 4px solid var(--st-resuelto); } .card-resuelto .number { color: var(--st-resuelto); }

        .table-container { background: var(--white); border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.05); padding: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; color: var(--primary-dark); padding: 15px; text-align: left; font-weight: 700; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; color: #555; vertical-align: middle; }
        
        .badge-estado { padding: 5px 10px; border-radius: 15px; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; border: 1px solid transparent; }
        .bdg-abierto { background: #ffebee; color: var(--st-abierto); border-color: #ffcdd2; }
        .bdg-espera_refaccion { background: #fff3e0; color: var(--st-espera); border-color: #ffe0b2; }
        .bdg-en_atencion { background: #fffde7; color: #bc9e0a; border-color: #fff9c4; }
        .bdg-resuelto { background: #e8f5e9; color: var(--st-resuelto); border-color: #c8e6c9; }

        .filters-bar { background: var(--white); padding: 20px; border-radius: 15px; margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .filter-group { flex: 1; min-width: 150px; }
        .filter-group label { font-size: 0.85rem; font-weight: 600; color: var(--primary-dark); display: block; margin-bottom: 5px; }
        .filter-group select, .filter-group input { width: 100%; padding: 10px; border: 1px solid #dde2ec; border-radius: 8px; font-size: 0.9rem; }
        .btn-limpiar { padding: 10px 20px; background-color: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-left: auto; }
        
        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header"><h3>INSITRA ADMIN</h3></div>
        <div style="padding-top: 20px;">
            <a class="menu-item active" onclick="mostrarVista('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</a>
            <a class="menu-item" onclick="mostrarVista('incidencias')"><i class="fas fa-ticket-alt"></i> Incidencias</a>
            <a class="menu-item" onclick="mostrarVista('creacion-tickets')"><i class="fas fa-plus-circle"></i> Crear Ticket</a>
            <a class="menu-item" onclick="mostrarVista('reportes')"><i class="fas fa-file-pdf"></i> Reportes</a>
            <a class="menu-item" onclick="mostrarVista('tecnicos')"><i class="fas fa-user-cog"></i> Técnicos</a>
            <a class="menu-item" onclick="mostrarVista('clientes')"><i class="fas fa-building"></i> Clientes</a>
        </div>
    </div>

    <div class="main-content">
        
        <div id="dashboard" class="view-section active">
            <h1 class="section-title">Dashboard General</h1>
            <div class="kpi-container">
                <div class="kpi-card card-total"><div class="kpi-content"><h3>Total Tickets</h3><div class="number" id="kpi-total">0</div></div><i class="fas fa-clipboard-list kpi-icon"></i></div>
                <div class="kpi-card card-abierto"><div class="kpi-content"><h3>Abiertos</h3><div class="number" id="kpi-abiertos">0</div></div><i class="fas fa-exclamation-circle kpi-icon"></i></div>
                <div class="kpi-card card-atencion"><div class="kpi-content"><h3>En Atención</h3><div class="number" id="kpi-atencion">0</div></div><i class="fas fa-tools kpi-icon"></i></div>
                <div class="kpi-card card-resuelto"><div class="kpi-content"><h3>Resueltos</h3><div class="number" id="kpi-resueltos">0</div></div><i class="fas fa-check-circle kpi-icon"></i></div>
            </div>
            <div class="table-container">
                <h3>Últimos Tickets (Resumen)</h3>
                <div style="overflow-x: auto;">
                    <table>
                        <thead><tr><th>ID</th><th>Empresa</th><th>Falla</th><th>Técnico</th><th>Fecha</th><th>Estado</th></tr></thead>
                        <tbody id="tabla-dashboard-resumen"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="creacion-tickets" class="view-section">
            <h1 class="section-title">Creación de Incidencias</h1>
            <div class="table-container" style="max-width: 800px; margin: 0 auto; padding: 30px;">
                <form id="form-nuevo-ticket" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="filter-group">
                        <label>Tipo de Ticket</label>
                        <input type="text" value="INTERNO" readonly style="background-color: #eee; cursor: not-allowed;">
                    </div>
                    <div class="filter-group">
                        <label>Número de Autobús</label>
                        <input type="text" id="tk-autobus" placeholder="Ej. ECO-123" required>
                    </div>
                    <div class="filter-group">
                        <label>Equipo</label>
                        <select id="tk-equipo-id" required onchange="cargarFallasPorEquipo(this.value)">
                            <option value="">Cargando equipos...</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Falla Reportada</label>
                        <select id="tk-falla-id" required disabled>
                            <option value="">Seleccione primero un equipo...</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Cliente (Reporta)</label>
                        <select id="tk-cliente" required>
                            <option value="">Cargando clientes...</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Técnico (Atiende)</label>
                        <select id="tk-tecnico" required>
                            <option value="">Cargando técnicos...</option>
                        </select>
                    </div>
                    <div style="grid-column: span 2; margin-top: 20px; display: flex; gap: 10px;">
                        <button type="button" onclick="guardarNuevoTicket()" class="btn-agregar" style="flex: 1; padding: 15px;">
                            <i class="fas fa-save"></i> Generar Ticket
                        </button>
                        <button type="button" class="btn-limpiar" onclick="limpiarFormularioTicket()" style="background-color: #555;">
                            <i class="fas fa-eraser"></i> Limpiar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://192.168.1.59:5000/api';
        let globalTickets = [];

        window.onload = function() {
            mostrarVista('dashboard');
            cargarDatosGlobales();
        };

        function mostrarVista(id) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            const target = document.getElementById(id);
            if(target) target.classList.add('active');
            
            if(id === 'creacion-tickets') {
                poblarSelectsTicket();
            }
        }

        async function cargarDatosGlobales() {
            try {
                const res = await fetch(`${API}/tickets`);
                if(!res.ok) throw new Error("Error API Tickets");
                globalTickets = await res.json();
                renderizarDashboard(globalTickets);
            } catch (e) { 
                console.error(e); 
            }
        }

        function renderizarDashboard(datos) {
            document.getElementById('kpi-total').innerText = datos.length;
            const tbody = document.getElementById('tabla-dashboard-resumen');
            tbody.innerHTML = '';
            datos.slice(0, 10).forEach(t => {
                const claseSt = `bdg-${(t.estado||'').toLowerCase().replace(' ', '_')}`;
                tbody.innerHTML += `<tr><td>#${t.id}</td><td>${t.empresa_nombre || '-'}</td><td>${t.falla_descripcion || '-'}</td><td>${t.tecnico_nombre || 'Sin Asignar'}</td><td>${t.fecha_creacion}</td><td><span class="badge-estado ${claseSt}">${t.estado}</span></td></tr>`;
            });
        }

        // --- LÓGICA DE CREACIÓN DE TICKETS ---

        async function poblarSelectsTicket() {
            try {
                // 1. Cargar Equipos (de la tabla 'equipo')
                const resEq = await fetch(`${API}/catalogos/equipo`);
                const equipos = await resEq.json();
                const selEq = document.getElementById('tk-equipo-id');
                selEq.innerHTML = '<option value="">Seleccione equipo...</option>';
                equipos.forEach(e => {
                    // Usamos e.equipo para el nombre y e.id para el valor segun tu tabla
                    selEq.add(new Option(e.equipo, e.id)); 
                });

                // 2. Cargar Técnicos
                const resTec = await fetch(`${API}/tecnicos`);
                const tecnicos = await resTec.json();
                const selTec = document.getElementById('tk-tecnico');
                selTec.innerHTML = '<option value="">Seleccione técnico...</option>';
                tecnicos.forEach(t => { if(t.activo) selTec.add(new Option(`${t.nombre} ${t.primer_apellido}`, t.id)); });

                // 3. Cargar Clientes
                const resCli = await fetch(`${API}/clientes`);
                const clientes = await resCli.json();
                const selCli = document.getElementById('tk-cliente');
                selCli.innerHTML = '<option value="">Seleccione cliente...</option>';
                clientes.forEach(c => { if(c.activo) selCli.add(new Option(c.nombre, c.id)); });

            } catch (e) {
                console.error("Error cargando catálogos", e);
            }
        }

        async function cargarFallasPorEquipo(equipoId) {
            const selFalla = document.getElementById('tk-falla-id');
            if (!equipoId) {
                selFalla.disabled = true;
                selFalla.innerHTML = '<option value="">Seleccione primero un equipo...</option>';
                return;
            }

            try {
                // Filtramos fallas por id_equipo segun tu estructura de tabla 'falla_reportada'
                const res = await fetch(`${API}/catalogos/falla_reportada?id_equipo=${equipoId}`);
                const fallas = await res.json();
                
                selFalla.innerHTML = '<option value="">Seleccione falla...</option>';
                selFalla.disabled = false;
                
                fallas.forEach(f => {
                    // Usamos f.falla para la descripción y f.id para el valor
                    selFalla.add(new Option(f.falla, f.id));
                });
            } catch (e) {
                console.error("Error al cargar fallas", e);
            }
        }

        async function guardarNuevoTicket() {
            const ticket = {
                tipo: "INTERNO",
                num_autobus: document.getElementById('tk-autobus').value,
                id_equipo: document.getElementById('tk-equipo-id').value,
                id_falla: document.getElementById('tk-falla-id').value,
                id_cliente: document.getElementById('tk-cliente').value,
                id_tecnico: document.getElementById('tk-tecnico').value,
                estado: 'ABIERTO',
                fecha_creacion: new Date().toISOString().split('T')[0]
            };

            if(!ticket.num_autobus || !ticket.id_equipo || !ticket.id_falla || !ticket.id_cliente || !ticket.id_tecnico) {
                alert("Por favor, complete todos los campos obligatorios");
                return;
            }

            try {
                const res = await fetch(`${API}/tickets`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(ticket)
                });

                if(res.ok) {
                    alert("Ticket creado con éxito");
                    limpiarFormularioTicket();
                    cargarDatosGlobales();
                    mostrarVista('dashboard');
                } else {
                    alert("Error al guardar el ticket");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        function limpiarFormularioTicket() {
            document.getElementById('form-nuevo-ticket').reset();
            const selFalla = document.getElementById('tk-falla-id');
            selFalla.disabled = true;
            selFalla.innerHTML = '<option value="">Seleccione primero un equipo...</option>';
        }
    </script>
</body>
</html>
